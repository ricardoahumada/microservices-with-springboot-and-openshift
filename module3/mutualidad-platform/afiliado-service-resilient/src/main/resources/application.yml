server:
  port: 8081

spring:
  application:
    name: afiliado-service-resilient
  datasource:
    url: jdbc:h2:mem:afiliadodb
    driver-class-name: org.h2.Driver
    username: sa
    password: 
  h2:
    console:
      enabled: true
      path: /h2-console
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true

# Configuracion de servicios externos
services:
  validacion:
    url: http://localhost:8084
  beneficio:
    url: http://localhost:8082
  notificacion:
    url: http://localhost:8083

# Feign Client configuration
feign:
  client:
    config:
      default:
        connectTimeout: 5000
        readTimeout: 5000
        loggerLevel: FULL
  circuitbreaker.enabled: true # activa el fallback de feign

# Resilience4j Configuration
resilience4j:
  # Circuit Breaker
  circuitbreaker:
    instances:
      validacionService:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 1
        slowCallRateThreshold: 80
        slowCallDurationThreshold: 2s
        recordExceptions:
          - java.io.IOException
          - java.util.concurrent.TimeoutException
          - feign.FeignException
        ignoreExceptions:
          - com.mutualidad.afiliado.domain.exception.BusinessException
      beneficioService:
        registerHealthIndicator: true
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 30s
      notificacionService:
        registerHealthIndicator: true
        slidingWindowSize: 5
        failureRateThreshold: 60
        waitDurationInOpenState: 20s

  # Retry
  retry:
    instances:
      validacionService:
        maxAttempts: 2
        waitDuration: 1s
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
        retryExceptions:
          - java.io.IOException
          - java.util.concurrent.TimeoutException
          - feign.FeignException.ServiceUnavailable
          - feign.FeignException.InternalServerError
        ignoreExceptions:
          - feign.FeignException.BadRequest
          - com.mutualidad.afiliado.domain.exception.BusinessException
      beneficioService:
        maxAttempts: 3
        waitDuration: 500ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
      notificacionService:
        maxAttempts: 2
        waitDuration: 500ms

  # Timeout
  timelimiter:
    instances:
      validacionService:
        timeoutDuration: 3s
        cancelRunningFuture: true
      beneficioService:
        timeoutDuration: 5s
      notificacionService:
        timeoutDuration: 5s

  # Rate Limiter (opcional)
  ratelimiter:
    instances:
      validacionService:
        limitForPeriod: 100
        limitRefreshPeriod: 1s
        timeoutDuration: 0

# Actuator configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,circuitbreakers,retries
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
      group:
        liveness:
          include: livenessState
        readiness:
          include: readinessState, db, validacionService, circuitBreakers
  health:
    circuitbreakers:
      enabled: true

logging:
  level:
    com.mutualidad: DEBUG
    io.github.resilience4j: DEBUG
