// =============================================================================
// EJERCICIO: Pipeline CI/CD Declarativo para afiliado-service
// =============================================================================
// Objetivo: Implementar un pipeline completo con agente Kubernetes, 
//           build, test, Docker y despliegue a OpenShift con Helm
// =============================================================================

pipeline {
    // TODO Ejercicio 1: Configurar agente Kubernetes
    // Implementar un pod con 3 contenedores:
    // - maven: maven:3.9-eclipse-temurin-11 (para build)
    // - docker: docker:24-cli (para construir imagenes)
    // - helm: alpine/helm:3.14.0 (para despliegue)
    // Configurar volumeMounts para cache de maven y docker socket
    agent any  // REEMPLAZAR con kubernetes agent

    // TODO Ejercicio 2: Definir parametros del pipeline
    // - ENVIRONMENT: choice (dev, qa, prod)
    // - SKIP_TESTS: booleanParam
    parameters {
        // Implementar parametros aqui
    }

    // TODO Ejercicio 3: Definir variables de entorno
    environment {
        APP_NAME = 'afiliado-service'
        APP_VERSION = '1.0.0'
        // Agregar: REGISTRY, OPENSHIFT_PROJECT, IMAGE_TAG
    }

    // TODO Ejercicio 4: Configurar opciones del pipeline
    options {
        // Implementar: buildDiscarder, timeout, timestamps, disableConcurrentBuilds
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                // TODO: Obtener GIT_COMMIT_SHORT y construir IMAGE_TAG dinamico
            }
        }

        stage('Build & Test') {
            steps {
                // TODO Ejercicio 5: Usar container 'maven' para build
                // Ejecutar: mvn clean package -DskipTests=${SKIP_TESTS}
                echo "TODO: Implementar build con Maven"
            }
            // TODO: Agregar post action para junit test results
        }

        stage('Code Analysis') {
            // TODO Ejercicio 6: Agregar condicion when para ejecutar solo en qa/prod
            steps {
                echo "TODO: Implementar analisis de codigo con SonarQube"
            }
        }

        stage('Docker Build & Push') {
            steps {
                // TODO Ejercicio 7: Usar container 'docker' para:
                // - docker build con tag ${REGISTRY}/${APP_NAME}:${IMAGE_TAG}
                // - docker push al registry
                echo "TODO: Implementar build y push de imagen Docker"
            }
        }

        stage('Deploy to OpenShift') {
            steps {
                // TODO Ejercicio 8: Usar container 'helm' para desplegar:
                // - helm upgrade --install con --atomic y --wait
                // - Usar values-${ENVIRONMENT}.yaml
                // - Override image.tag e image.repository
                echo "TODO: Implementar despliegue con Helm"
            }
        }

        stage('Verify Deployment') {
            steps {
                // TODO Ejercicio 9: Verificar despliegue:
                // - helm status
                // - kubectl get pods
                echo "TODO: Implementar verificacion de despliegue"
            }
        }

        stage('Production Approval') {
            // TODO Ejercicio 10: Agregar input para aprobacion manual en prod
            when {
                expression { false }  // Cambiar condicion
            }
            steps {
                echo "TODO: Implementar aprobacion para produccion"
            }
        }
    }

    // TODO Ejercicio 11: Implementar post actions
    post {
        success {
            echo "Pipeline completed successfully"
            // Agregar notificacion Slack
        }
        failure {
            echo "Pipeline failed"
            // Agregar notificacion Slack
        }
        always {
            // Limpiar workspace
        }
    }
}
